<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href="/css/style.min.744f758497484f98d65b02d6ff46ee5e38ccf9903976ffd1eaef6ad7401fa99b.css" integrity="sha256-dE91hJdIT5jWWwLW/0buXjjM+ZA5dv/R6u9q10AfqZs="><link rel=stylesheet type=text/css href=/css/syntax-light.min.c3f7545ba2ec853ed9c45e1ac5856a1d2976599c771c238e3a8f73be8bb6a91b.css integrity="sha256-w/dUW6LshT7ZxF4axYVqHSl2WZx3HCOOOo9zvou2qRs=" media="screen and (prefers-color-scheme: light)"><link rel=stylesheet type=text/css href=/css/syntax-dark.min.5d9aada6e7d12e754185f88ac16235771e30527e759abbe1080261284c214c0c.css integrity="sha256-XZqtpufRLnVBhfiKwWI1dx4wUn51mrvhCAJhKEwhTAw=" media="screen and (prefers-color-scheme: dark)"><meta name=description content="For the past couple of weeks I&amp;rsquo;ve been trying out new things. New to me, anyway. And as you might expect, I&amp;rsquo;m really bad at them. Let&amp;rsquo;s talk about that!"><title>Sporiff.dev | Back to the drawing board</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=%3cnil%3e><link rel=icon type=image/png sizes=16x16 href=%3cnil%3e><link rel=manifest href=/site.webmanifest><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rootkey.fra1.cdn.digitaloceanspaces.com/images/avatar.webp"><meta name=twitter:title content="Back to the drawing board"><meta name=twitter:description content="For the past couple of weeks I&rsquo;ve been trying out new things. New to me, anyway. And as you might expect, I&rsquo;m really bad at them. Let&rsquo;s talk about that!"></head><header><nav class=secondary><div><a class=nav-link href=/>Home</a>
<a class=nav-link href=/posts>Posts</a>
<a class=nav-link href=/about>About me</a></div></nav></header><body><section id=content><article><h1>Back to the drawing board</h1><div><div class=byline><div class=avatar><img src=https://rootkey.fra1.cdn.digitaloceanspaces.com/images/avatar.webp alt="Avatar for Ciarán Ainsworth" width=48px height=48px></div><div class=author>Ciarán Ainsworth</div><time datetime=2018-06-15>Jun 15, 2018</time></div><aside class=tags><a class=tag href=tags/tech>tech</a>
<a class=tag href=tags/moodle>moodle</a>
<a class=tag href=tags/gnu>gnu</a>
<a class=tag href=tags/linux>linux</a>
<a class=tag href=tags/centos>centos</a>
<a class=tag href=tags/azure>azure</a></aside></div><br><br><p>For the past couple of weeks I&rsquo;ve been trying out new things. New to me, anyway. And as you might expect, I&rsquo;m really bad at them. Let&rsquo;s talk about that!</p><h2 id=why-did-it-have-to-be-moodle>Why did it have to be Moodle?</h2><p>I work in a very Microsoft-centric environment. The vast majority of our servers are Windows 2016, 2012 R2, and a few straggling 2008 R2 boxes which just refuse to die. Possibly for this reason, we&rsquo;ve never had a GNU/Linux technician. Our head of IT is very Linux-literate, but also time-poor. When I moved from the frontline team to the systems team, then, all the Linux responsibilities immediately fell to me.</p><p>Fan-fucking-tastic.</p><p>My first job with GNU/Linux was to automate patching for the servers and EPOS systems as they hadn&rsquo;t been patched in years. That was all simple enough, just write out a nice little cron job with logging and leave them to it. Much less hands-on than trying to manage WSUS. But of all these servers the two most problematic ones are definitely our CentOS boxes which power Moodle.</p><p>I had no experience with Moodle until this week, but I had some experience with CentOS. Enough to know that these boxes had been set up by a monkey with absolutely no knowledge of how to partition disk space, set up Apache, or do pretty much anything with GNU/Linux. So when it came time to upgrade Moodle, I was pretty confident that we were going to be boned.</p><p>Luckily, we managed to get the upgrade on the test server finished (not without some trial and error), but much of the way it was set up left myself and our Moodle dev scratching our heads with a &ldquo;why the fuck did they do that?&rdquo; kind of confuzzlement. Hopefully, this experiment will translate well when we do the live upgrade in a few months, and then we&rsquo;ll be able to design the whole server-side from scratch and push it into Azure with proper load-balancing.</p><h2 id=speaking-of-azure>Speaking of Azure</h2><p>So in <a href=/posts/2018/some-more-windows-work/>this post</a> I detailed some of the trouble we&rsquo;ve been having with getting devices into AAD and Intune management using an SCCM build sequence. I have a quick update to that as well. When last we looked at it we had got devices auto-enrolling in AAD but had yet to hand authority to Intune. When we eventually got the auto enrolment sorted (turns out you have to assign authority to the user group in O365 admin panel, not Azure panel. Go figure) we were still having issues managing the devices in any real way. Intune was simply saying &ldquo;MDM status: see configmgr&rdquo;. Hum.</p><p>My co-worker quickly realised that the <code>SMSTSPostAction</code> I&rsquo;d set up was working in that it removed the CCM client from the machine, but it wasn&rsquo;t fully successful in turning off EVERY element of CCM&rsquo;s authority. While you&rsquo;d have thought that uninstalling the client would take authority away, it turns out that it really just leaves it in a managed state as though waiting for CCM to gain control again. Not ideal. With a bit of research my colleague figured out which regkey to turn off and I started writing the new script.</p><p>This was a bit more involved than running a simple command line like before. First we needed to change the <code>SMSTSPostAction</code> to call on the PowerShell script from a local directory in bypass mode. Then, as the last step, we needed to map a drive to point to the script&rsquo;s location and use another PowerShell script to copy the CCM removal script to the <code>C:\Windows\Temp</code> directory to be executed post OSD completion. The script itself goes like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nb>Start-Process</span> <span class=n>-FilePath</span> <span class=s1>&#39;C:\Windows\ccmsetup\ccmsetup.exe&#39;</span> <span class=n>-Args</span> <span class=s2>&#34;/uninstall&#34;</span> <span class=n>-Wait</span> <span class=n>-NoNewWindow</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=c># wait for exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nv>$CCMProcess</span> <span class=p>=</span> <span class=nb>Get-Process</span> <span class=n>ccmsetup</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=k>try</span><span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nv>$CCMProcess</span><span class=p>.</span><span class=n>WaitForExit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>   <span class=p>}</span><span class=k>catch</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=c># Stop Services</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=nb>Stop-Service</span> <span class=n>-Name</span> <span class=n>ccmsetup</span> <span class=n>-Force</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Stop-Service</span> <span class=n>-Name</span> <span class=n>CcmExec</span> <span class=n>-Force</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Stop-Service</span> <span class=n>-Name</span> <span class=n>smstsmgr</span> <span class=n>-Force</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Stop-Service</span> <span class=n>-Name</span> <span class=n>CmRcService</span> <span class=n>-Force</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=c># wait for exit</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=nv>$CCMProcess</span> <span class=p>=</span> <span class=nb>Get-Process</span> <span class=n>ccmexec</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=k>try</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>      <span class=nv>$CCMProcess</span><span class=p>.</span><span class=n>WaitForExit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=p>}</span><span class=k>catch</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=c># Remove WMI Namespaces</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;SELECT * FROM __Namespace WHERE Name=&#39;ccm&#39;&#34;</span> <span class=n>-Namespace</span> <span class=n>root</span> <span class=p>|</span> <span class=nb>Remove-WmiObject</span>
</span></span><span class=line><span class=cl>   <span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;SELECT * FROM __Namespace WHERE Name=&#39;sms&#39;&#34;</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>cimv2</span> <span class=p>|</span> <span class=nb>Remove-WmiObject</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=c># Remove Services from Registry</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=nv>$MyPath</span> <span class=p>=</span> <span class=err>“</span><span class=n>HKLM</span><span class=err>:</span><span class=p>\</span><span class=n>SYSTEM</span><span class=p>\</span><span class=n>CurrentControlSet</span><span class=p>\</span><span class=n>Services</span><span class=err>”</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>CCMSetup</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>CcmExec</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>smstsmgr</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>CmRcService</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=c># Remove SCCM Client from Registry</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=nv>$MyPath</span> <span class=p>=</span> <span class=err>“</span><span class=n>HKLM</span><span class=err>:</span><span class=p>\</span><span class=n>SOFTWARE</span><span class=p>\</span><span class=n>Microsoft</span><span class=err>”</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>CCM</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>CCMSetup</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>SMS</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c># Remove Folders and Files</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=nv>$MyPath</span> <span class=p>=</span> <span class=nv>$env:WinDir</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>CCM</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>ccmsetup</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>ccmcache</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>SMSCFG</span><span class=p>.</span><span class=n>ini</span> <span class=n>-Force</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>SMS</span><span class=p>*.</span><span class=n>mif</span> <span class=n>-Force</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>SMS</span><span class=p>*.</span><span class=n>mif</span> <span class=n>-Force</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=c>#Remove authority from CCM</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=nv>$MyPath</span> <span class=p>=</span> <span class=err>“</span><span class=n>HKLM</span><span class=err>:</span><span class=p>\</span><span class=n>SOFTWARE</span><span class=p>\</span><span class=n>Microsoft</span><span class=err>”</span>
</span></span><span class=line><span class=cl>   <span class=nb>Remove-Item</span> <span class=n>-Path</span> <span class=nv>$MyPath</span><span class=p>\</span><span class=n>DeviceManageabilityCSP</span> <span class=n>-Force</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span>
</span></span></code></pre></div><p>A little lengthy compared to the last one, but lo and behold Intune picked up the new machine and started applying policies. Huzzah!</p></article></section><footer>Copyright (c) 2022 Ciarán Ainsworth</footer></body></html>