<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href="/css/style.min.aae8ee50883b584313558270574543eede36d83be93537b1b82e3f25224db67a.css" integrity="sha256-qujuUIg7WEMTVYJwV0VD7t422DvpNTexuC4/JSJNtno="><link rel=stylesheet type=text/css href=/css/syntax-light.min.c3f7545ba2ec853ed9c45e1ac5856a1d2976599c771c238e3a8f73be8bb6a91b.css integrity="sha256-w/dUW6LshT7ZxF4axYVqHSl2WZx3HCOOOo9zvou2qRs=" media="screen and (prefers-color-scheme: light)"><link rel=stylesheet type=text/css href=/css/syntax-dark.min.5d9aada6e7d12e754185f88ac16235771e30527e759abbe1080261284c214c0c.css integrity="sha256-XZqtpufRLnVBhfiKwWI1dx4wUn51mrvhCAJhKEwhTAw=" media="screen and (prefers-color-scheme: dark)"><meta name=description content="So you want to use Microsoft Teams in your organisation, huh? Are you prepared for the pain? The lack of documentation? The feeling of utter exasperation at a company unable to properly consider the needs of enterprise customers in their new &amp;ldquo;modern&amp;rdquo; approach?"><title>Sporiff.dev | Microsoft Teams deployment headaches</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=%3cnil%3e><link rel=icon type=image/png sizes=16x16 href=%3cnil%3e><link rel=manifest href=/site.webmanifest><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rootkey.fra1.cdn.digitaloceanspaces.com/images/avatar.webp"><meta name=twitter:title content="Microsoft Teams deployment headaches"><meta name=twitter:description content="So you want to use Microsoft Teams in your organisation, huh? Are you prepared for the pain? The lack of documentation? The feeling of utter exasperation at a company unable to properly consider the needs of enterprise customers in their new &ldquo;modern&rdquo; approach?"></head><header><nav class=secondary><div><a class=nav-link href=/>Home</a>
<a class=nav-link href=/posts>Posts</a>
<a class=nav-link href=/about>About me</a></div></nav></header><body><section id=content><article><h1>Microsoft Teams deployment headaches</h1><div><div class=byline><div class=avatar><img src=https://rootkey.fra1.cdn.digitaloceanspaces.com/images/avatar.webp alt="Avatar for Ciarán Ainsworth" width=48px height=48px></div><div class=author>Ciarán Ainsworth</div><time datetime=2018-07-13>Jul 13, 2018</time></div><aside class=tags><a class=tag href=tags/tech>tech</a>
<a class=tag href=tags/windows>windows</a>
<a class=tag href=tags/teams>teams</a>
<a class=tag href=tags/microsoft>microsoft</a>
<a class=tag href=tags/intune>intune</a>
<a class=tag href=tags/azure>azure</a>
<a class=tag href=tags/sccm>sccm</a></aside></div><br><br><p>So you want to use Microsoft Teams in your organisation, huh? Are you prepared for the pain? The lack of documentation? The feeling of utter exasperation at a company unable to properly consider the needs of enterprise customers in their new &ldquo;modern&rdquo; approach? Well, I&rsquo;m here to share my experiences with you so that hopefully you can avoid some of the pain I had to go through in getting this all ready for our upcoming rollout.</p><h2 id=sccm-deployments>SCCM deployments</h2><p>Like many of you, my organisation utilises Microsoft&rsquo;s powerhouse deployment tool: SCCM. Initially, when Teams was released it was only available as an executable, which is fine. A little jiggery-pokery with detection methods yielded a usable application which could easily be deployed and self-served by users. Unfortunately, deploying the <code>.exe</code> and then trying to switch to the <code>.msi</code> requires the use of a <a href=https://docs.microsoft.com/en-us/MicrosoftTeams/scripts/powershell-script-teams-deployment-clean-up%5D>cleanup script</a> so we were lucky that Microsoft – in their infinite wisdom – decided to release <a href=https://docs.microsoft.com/en-us/MicrosoftTeams/msi-deployment>the .msi &ldquo;machine-wide installer&rdquo;</a> before we started deploying. Saves us a bit of work.</p><p>The <code>.msi</code> installer, as you might imagine, works perfectly as an application. The only caveat is that the installer is per-user no matter what you specify in your application settings. The program installs to the users&rsquo; AppData folder, so it can cause headaches in environments which make use of redirected AppData.</p><h2 id=intune-deployments>Intune deployments</h2><p>This is where things got a lot more complicated. Intune is at once a product with a great deal of documentation and one with absolutely no useful information. So when my co-worker and I initially uploaded the <code>.msi</code> to Intune we expected it to work. Nobody else had complained of any issues with the deployment via Intune, so we were surprised when every attempt at installation came back as having failed.</p><p>So here&rsquo;s the thing: Intune <strong>hates</strong> deployments based on devices. Nearly every device configuration profile, compliance profile, and application deployment is expected to be done per-user. This does not fit our use-case, as users need to interact with many different devices in different contexts (e.g. shared user devices and personal devices). For that reason, we&rsquo;ve had a lot of problems getting policies to work and are currently trying to get M$ to fix the issue.</p><p>But what about Teams? After all, the Chrome Enterprise installer worked fine targeting devices. The error message from Intune was that devices could not be targeted with user-based installers. But Teams is a &ldquo;machine-wide installer&rdquo;, right? Well, no. Not exactly. The installer basically just sets up a base downloader that is initiated by a user logging in. So how do you get Intune to recognise it as a device installer? You edit the <code>.msi</code> of course.</p><p>I personally use <a href=http://www.pantaray.com/msi_super_orca.html>SuperOrca</a> to do this, but there are other tools available which can do the same job. Basically you just load up the <code>.msi</code> and add the following value to a new row. This will set the default installation target to &ldquo;machine&rdquo;, and will enable deployment of the <code>.msi</code> to device collections within Intune.</p><h2 id=stopping-autostart>Stopping AutoStart</h2><p>The single most annoying thing about Microsoft Teams is its inability to shut up. By default, the application is set to launch in the foreground at login. It&rsquo;s not a small app, either, so on older machines it increases load up time substantially. When you&rsquo;re trying to get non-techie users to use new tech (teachers, for example) the <strong>last</strong> thing you want to do is annoy them with clunky, slow applications.</p><p>So, I started poring over the documentation looking for an enterprise kill switch for this behaviour. An ADMX template, maybe? Doesn&rsquo;t look like it. A native GPO for Teams behaviour? Nope. Hmm. Okay then. Let&rsquo;s brush off <a href=https://docs.microsoft.com/en-us/sysinternals/downloads/procmon>Procmon</a> and look at what this is doing.</p><p>So it looks like when you enable/disable the autostart from within the Teams desktop application it writes and verifies a bunch of regkeys. The one we&rsquo;re interested in is this one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>HKCU</span><span class=p>\</span><span class=n>Software</span><span class=p>\</span><span class=n>Microsoft</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>CurrentVersion</span><span class=p>\</span><span class=n>Run</span>
</span></span><span class=line><span class=cl><span class=n>com</span><span class=p>.</span><span class=n>squirrel</span><span class=p>.</span><span class=n>Teams</span><span class=p>.</span><span class=n>Teams</span>
</span></span><span class=line><span class=cl><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=k>%</span><span class=n>currentuser</span><span class=p>%\</span><span class=n>AppData</span><span class=p>\</span><span class=n>Local</span><span class=p>\</span><span class=n>Microsoft</span><span class=p>\</span><span class=n>Teams</span><span class=p>\</span><span class=n>Update</span><span class=p>.</span><span class=n>exe</span> <span class=p>-</span><span class=n>-processStart</span> <span class=s2>&#34;Teams.exe&#34;</span> <span class=p>-</span><span class=n>-process-start-args</span> <span class=s2>&#34;--system-initiated&#34;</span>
</span></span></code></pre></div><p>So, by creating a login script using group policy which searches for and removes this key, we effectively wipe out the autostart behaviour. Now, we have a working Teams deployment on SCCM. As for Intune, it remains to be seen whether or not creating a CSP and installing local GPOs will consistently suppress autostart. To be tested next week.</p></article></section><footer>Copyright (c) 2022 Ciarán Ainsworth</footer></body></html>