<!doctype html><html dir=ltr lang=en data-theme class=html><head><title>Ciarán Ainsworth
|
Back to the drawing board</title><meta charset=utf-8><meta name=generator content="Hugo 0.98.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Ciarán Ainsworth"><meta name=description content="
      I write about things for a living


    "><link rel=stylesheet href=/scss/main.min.5551757e3608c8c17519a404d0c78646f8b4ce68b04e5acc290a21597ce09467.css integrity="sha256-VVF1fjYIyMF1GaQE0MeGRvi0zmiwTlrMKQohWXzglGc=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/custom.min.ec0e83e7d616d38ef6d5b475ac380ecf1b0231c475feef0592fe0299f5ccf347.css integrity="sha256-7A6D59YW04721bR1rDgOzxsCMcR1/u8Fkv4CmfXM80c=" crossorigin=anonymous media=screen><link rel=stylesheet href=/fontawesome/css/fontawesome.min.69685904d5c2a0c6258d03c207b778c10466edf6cea928cc0164c376b0ad0930.css integrity="sha256-aWhZBNXCoMYljQPCB7d4wQRm7fbOqSjMAWTDdrCtCTA=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.6d585e78d28cce1200d39fb133c92ed83df01738da721d0f48fb6eac62d24e04.css integrity="sha256-bVheeNKMzhIA05+xM8ku2D3wFzjach0PSPturGLSTgQ=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.6b00d96498d59caa0dbcf9b49d30d821915291f2ceb0e19248523c8607ff43fa.css integrity="sha256-awDZZJjVnKoNvPm0nTDYIZFSkfLOsOGSSFI8hgf/Q/o=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=/posts/back-to-the-drawing-board/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.560a26330d27ff44a44e83b53cd07a95d4230a65930d31c5c76a8d481e5b35bf.js integrity="sha256-VgomMw0n/0SkToO1PNB6ldQjCmWTDTHFx2qNSB5bNb8=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/Avatar.png"><meta name=twitter:title content="Back to the drawing board"><meta name=twitter:description content="For the past couple of weeks I&rsquo;ve been trying out new things. New to me, anyway. And as you might expect, I&rsquo;m really bad at them. Let&rsquo;s talk about that!
Why did it have to be Moodle? I work in a very Microsoft-centric environment. The vast majority of our servers are Windows 2016, 2012 R2, and a few straggling 2008 R2 boxes which just refuse to die. Possibly for this reason, we&rsquo;ve never had a GNU/Linux technician."><meta property="og:title" content="Back to the drawing board"><meta property="og:description" content="For the past couple of weeks I&rsquo;ve been trying out new things. New to me, anyway. And as you might expect, I&rsquo;m really bad at them. Let&rsquo;s talk about that!
Why did it have to be Moodle? I work in a very Microsoft-centric environment. The vast majority of our servers are Windows 2016, 2012 R2, and a few straggling 2008 R2 boxes which just refuse to die. Possibly for this reason, we&rsquo;ve never had a GNU/Linux technician."><meta property="og:type" content="article"><meta property="og:url" content="/posts/back-to-the-drawing-board/"><meta property="og:image" content="/images/Avatar.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-06-15T23:00:00+00:00"><meta property="article:modified_time" content="2018-06-15T23:00:00+00:00"><meta property="og:site_name" content="Life inside a computer"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"Back to the drawing board","headline":"Back to the drawing board","alternativeHeadline":"","description":"
      
        For the past couple of weeks I\u0026rsquo;ve been trying out new things. New to me, anyway. And as you might expect, I\u0026rsquo;m really bad at them. Let\u0026rsquo;s talk about that!\nWhy did it have to be Moodle? I work in a very Microsoft-centric environment. The vast majority of our servers are Windows 2016, 2012 R2, and a few straggling 2008 R2 boxes which just refuse to die. Possibly for this reason, we\u0026rsquo;ve never had a GNU\/Linux technician.


      


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/back-to-the-drawing-board\/"},"author":{"@type":"Person","name":"Ciarán Ainsworth"},"creator":{"@type":"Person","name":"Ciarán Ainsworth"},"accountablePerson":{"@type":"Person","name":"Ciarán Ainsworth"},"copyrightHolder":{"@type":"Person","name":"Ciarán Ainsworth"},"copyrightYear":"2018","dateCreated":"2018-06-15T23:00:00.00Z","datePublished":"2018-06-15T23:00:00.00Z","dateModified":"2018-06-15T23:00:00.00Z","publisher":{"@type":"Organization","name":"Ciarán Ainsworth","url":"","logo":{"@type":"ImageObject","url":"favicon-32x32.png","width":"32","height":"32"}},"image":["/images/Avatar.png"],"url":"\/posts\/back-to-the-drawing-board\/","wordCount":"846","genre":["blog"],"keywords":["tech","moodle","gnu","linux","centos","azure"]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/Avatar.png alt="profile picture"><div class=sidebar__introduction-title><a href=/>Life inside a computer</a></div><div class=sidebar__introduction-description><p>I write about things for a living</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://twitter.com/thatdapperbrit rel=me aria-label title><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://mastodon.technology/@cda rel=me aria-label title><i class="fab fa-mastodon fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=mailto:ciaranainsworth@icloud.com rel=me aria-label title><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/Sporiff rel=me aria-label title><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.paypal.com/paypalme/cdainsworth rel=me aria-label title><i class="fab fa-paypal fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
Ciarán Ainsworth
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.9c062c557275acbaba71f0c7cd4024da3e3cc825d248bc4b2130811b0965330b.js integrity="sha256-nAYsVXJ1rLq6cfDHzUAk2j48yCXSSLxLITCBGwllMws=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/about title>About me</a></li><li class=nav__list-item><a href=/portfolio title>Portfolio</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Back to the Drawing Board</h1><ul class=post__meta><li class=post__meta-item><em class="fas fa-calendar-day post__meta-icon"></em>
<span class=post__meta-text>Fri, Jun 15, 2018</span></li><li class=post__meta-item><em class="fas fa-stopwatch post__meta-icon"></em>
<span class=post__meta-text>4-minute read</span></li></ul><div class=alert><div class=alert__indicator>!</div>Warning: This post is over 365 days old. The information may be out of date.</div><p>For the past couple of weeks I&rsquo;ve been trying out new things. New to me, anyway. And as you might expect, I&rsquo;m really bad at them. Let&rsquo;s talk about that!</p><h2 id=why-did-it-have-to-be-moodle>Why did it have to be Moodle?</h2><p>I work in a very Microsoft-centric environment. The vast majority of our servers are Windows 2016, 2012 R2, and a few straggling 2008 R2 boxes which just refuse to die. Possibly for this reason, we&rsquo;ve never had a GNU/Linux technician. Our head of IT is very Linux-literate, but also time-poor. When I moved from the frontline team to the systems team, then, all the Linux responsibilities immediately fell to me.</p><p>Fan-fucking-tastic.</p><p>My first job with GNU/Linux was to automate patching for the servers and EPOS systems as they hadn&rsquo;t been patched in years. That was all simple enough, just write out a nice little cron job with logging and leave them to it. Much less hands-on than trying to manage WSUS. But of all these servers the two most problematic ones are definitely our CentOS boxes which power Moodle.</p><p>I had no experience with Moodle until this week, but I had some experience with CentOS. Enough to know that these boxes had been set up by a monkey with absolutely no knowledge of how to partition disk space, set up Apache, or do pretty much anything with GNU/Linux. So when it came time to upgrade Moodle, I was pretty confident that we were going to be boned.</p><p>Luckily, we managed to get the upgrade on the test server finished (not without some trial and error), but much of the way it was set up left myself and our Moodle dev scratching our heads with a &ldquo;why the fuck did they do that?&rdquo; kind of confuzzlement. Hopefully, this experiment will translate well when we do the live upgrade in a few months, and then we&rsquo;ll be able to design the whole server-side from scratch and push it into Azure with proper load-balancing.</p><h2 id=speaking-of-azure>Speaking of Azure</h2><p>So in <a href=/posts/some-more-windows-work/>this post</a> I detailed some of the trouble we&rsquo;ve been having with getting devices into AAD and Intune management using an SCCM build sequence. I have a quick update to that as well. When last we looked at it we had got devices auto-enrolling in AAD but had yet to hand authority to Intune. When we eventually got the auto enrolment sorted (turns out you have to assign authority to the user group in O365 admin panel, not Azure panel. Go figure) we were still having issues managing the devices in any real way. Intune was simply saying &ldquo;MDM status: see configmgr&rdquo;. Hum.</p><p>My co-worker quickly realised that the <code>SMSTSPostAction</code> I&rsquo;d set up was working in that it removed the CCM client from the machine, but it wasn&rsquo;t fully successful in turning off EVERY element of CCM&rsquo;s authority. While you&rsquo;d have thought that uninstalling the client would take authority away, it turns out that it really just leaves it in a managed state as though waiting for CCM to gain control again. Not ideal. With a bit of research my colleague figured out which regkey to turn off and I started writing the new script.</p><p>This was a bit more involved than running a simple command line like before. First we needed to change the <code>SMSTSPostAction</code> to call on the PowerShell script from a local directory in bypass mode. Then, as the last step, we needed to map a drive to point to the script&rsquo;s location and use another PowerShell script to copy the CCM removal script to the <code>C:\Windows\Temp</code> directory to be executed post OSD completion. The script itself goes like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>
</span></span><span style=display:flex><span>   Start-Process -FilePath <span style=color:#e6db74>&#39;C:\Windows\ccmsetup\ccmsetup.exe&#39;</span> -Args <span style=color:#e6db74>&#34;/uninstall&#34;</span> -Wait -NoNewWindow
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#75715e># wait for exit</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   $CCMProcess = Get-Process ccmsetup -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>try</span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      $CCMProcess.WaitForExit()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>   }<span style=color:#66d9ef>catch</span>{
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#75715e># Stop Services</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   Stop-Service -Name ccmsetup -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Stop-Service -Name CcmExec -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Stop-Service -Name smstsmgr -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Stop-Service -Name CmRcService -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#75715e># wait for exit</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   $CCMProcess = Get-Process ccmexec -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>try</span>{
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>      $CCMProcess.WaitForExit()
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   }<span style=color:#66d9ef>catch</span>{
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#75715e># Remove WMI Namespaces</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Get-WmiObject -Query <span style=color:#e6db74>&#34;SELECT * FROM __Namespace WHERE Name=&#39;ccm&#39;&#34;</span> -Namespace root | Remove-WmiObject
</span></span><span style=display:flex><span>   Get-WmiObject -Query <span style=color:#e6db74>&#34;SELECT * FROM __Namespace WHERE Name=&#39;sms&#39;&#34;</span> -Namespace root\cimv2 | Remove-WmiObject
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#75715e># Remove Services from Registry</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   $MyPath = <span style=color:#960050;background-color:#1e0010>“</span>HKLM<span style=color:#960050;background-color:#1e0010>:</span>\SYSTEM\CurrentControlSet\Services<span style=color:#960050;background-color:#1e0010>”</span>
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\CCMSetup -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\CcmExec -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\smstsmgr -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\CmRcService -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#75715e># Remove SCCM Client from Registry</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   $MyPath = <span style=color:#960050;background-color:#1e0010>“</span>HKLM<span style=color:#960050;background-color:#1e0010>:</span>\SOFTWARE\Microsoft<span style=color:#960050;background-color:#1e0010>”</span>
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\CCM -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\CCMSetup -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\SMS -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># Remove Folders and Files</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   $MyPath = $env:WinDir
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\CCM -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\ccmsetup -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\ccmcache -Force -Recurse -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\SMSCFG.ini -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\SMS*.mif -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\SMS*.mif -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#75715e>#Remove authority from CCM</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   $MyPath = <span style=color:#960050;background-color:#1e0010>“</span>HKLM<span style=color:#960050;background-color:#1e0010>:</span>\SOFTWARE\Microsoft<span style=color:#960050;background-color:#1e0010>”</span>
</span></span><span style=display:flex><span>   Remove-Item -Path $MyPath\DeviceManageabilityCSP -Force -Recurse -ErrorAction SilentlyContinue
</span></span></code></pre></div><p>A little lengthy compared to the last one, but lo and behold Intune picked up the new machine and started applying policies. Huzzah!</p></div><div class=post__footer><span><a class=category href=/categories/blog/>blog</a></span>
<span><a class=tag href=/tags/tech/>tech</a><a class=tag href=/tags/moodle/>moodle</a><a class=tag href=/tags/gnu/>gnu</a><a class=tag href=/tags/linux/>linux</a><a class=tag href=/tags/centos/>centos</a><a class=tag href=/tags/azure/>azure</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
Ciarán Ainsworth
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.9c062c557275acbaba71f0c7cd4024da3e3cc825d248bc4b2130811b0965330b.js integrity="sha256-nAYsVXJ1rLq6cfDHzUAk2j48yCXSSLxLITCBGwllMws=" crossorigin=anonymous></script></body></html>