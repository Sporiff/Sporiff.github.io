<!doctype html>
<html lang="en"> <head> <title>Life Inside a Computer</title> <meta http-equiv="content-type" content="text/html;" charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link href="https://sporiff.github.io/css/style.min.css" rel="stylesheet" type="text/css" /> <link rel="alternate" href="https://sporiff.github.io/rss.xml" type="application/rss+xml" /> <link rel="icon" type="image/png" href="https://sporiff.github.io/css/favicon.png" /> <meta name="flattr:id" content="d7zprl"> <meta property="twitter:card" content="summary" />
<meta property="twitter:author" content="@thatdapperbrit" />
<meta property="twitter:title" content="Deploying Sophos in a Production Environment" />
<meta property="twitter:description" content="<p>AntiVirus is a necessary evil. With the world more connected than ever before, every device 
needs protection and tools to allow administrators oversight. Currently, the AV I work with is 
Sophos;" /> </head> <body> <nav class="navigation"> <a href="https://sporiff.github.io">Home</a> | <a href="mailto:ciaranainsworth@outlook.com">Email</a>  | <a href="https://github.com/Sporiff">Code</a>  | <a href="https://paypal.me/CiaranAinsworth">Support me</a>  | <a href="https://assets.rootkey.co.uk/static/resume.pdf">Resumé</a>  | <a href="https://sporiff.github.io/atom.xml">RSS</a>  </nav> <main id="content"> <section class="article-meta">
<h1 class="title">Deploying Sophos in a Production Environment</h1>
<details open> <summary>Article Information</summary> <section class="tags">
Tagged as <a href="https://sporiff.github.io/tag/sophos.html">sophos</a>, <a href="https://sporiff.github.io/tag/av.html">av</a>, <a href="https://sporiff.github.io/tag/sysadmin.html">sysadmin</a>, <a href="https://sporiff.github.io/tag/tech.html">tech</a>, <a href="https://sporiff.github.io/tag/antivirus.html">antivirus</a>, <a href="https://sporiff.github.io/tag/sccm.html">sccm</a>, <a href="https://sporiff.github.io/tag/azure.html">azure</a>, <a href="https://sporiff.github.io/tag/intune.html">intune</a> </section>
<section class="date">
Written on <time datetime="2018-05-08">2018-05-08</time> </section>
</section>
<article class="article-content">
<p>AntiVirus is a necessary evil. With the world more connected than ever before, every device 
needs protection and tools to allow administrators oversight. Currently, the AV I work with is 
Sophos; cloud-based solution for Windows, Mac, and Linux. When I was working on the frontline, 
I quickly became aware that Sophos did not deploy during imaging as it had initially done, nor 
could it easily be pushed out via SCCM. We spent a long time going around to each freshly imaged 
machine and loading Sophos on, rebooting the machine, and logging tickets to have its policy applied. 
This did not sit right with me, so upon my move to the systems team I decided to have a crack at 
simplifying the process.</p>

<h2>Build Deployment</h2>

<p>The issue, I soon discovered, was not one of packaging or deployment, but rather time. Sophos' installer 
goes out of date every 30 days, at which point a new executable needs to be downloaded for any new deployments. 
Understandably, this was not a practical solution for our application manager. Given my GNU/Linux background, 
the solution seemed straightforward enough: write a script to handle download and installation as one does with 
the Linux client. However, while this was easily facilitated by PowerShell's Invoke-WebRequest cmdlet on 
Windows 10, Windows 7's older (v2) Powershell had no such functionality. So we were faced with a dilemma: 
upgrade PowerShell or find a way to script the download and install in an older environment.</p>

<p>The first option seemed the best to both of us, as more PowerShell features for technicians on a machine could 
be useful in the long run. However, we encountered endless issues trying to deploy the upgrade packages in the 
OSD, so eventually I sat down to work out the script in .NET. The result was a much less clean but still functional 
PowerShell script.</p>

<p>Both of these scripts can be found on my <a href="https://git.sr.ht/~sporiff/sophos-install" >Sourcehut</a>.</p>

<h2>Protecting macOS</h2>

<p>macOS is somewhat more familiar to me than Windows due to its UNIX base, but I was not yet used to working 
with DeployStudio to image macOS devices. I decided that if I could automate deployment for Windows, the 
same must be easy enough on macOS. Certainly, the download command curl is a lot more familiar to me than 
<code>Invoke-WebRequest</code>, however the installation of Sophos from a <code>.zip</code> required many more steps than simply 
executing a <code>.exe</code> like in Windows. More importantly, I came across another issue.</p>

<p><a href="https://community.sophos.com/kb/en-us/131749" >Sophos had reported</a> a change to their installer which 
caused it to conflict with the default permissions set by DeployStudio during imaging. For this reason, 
it was necessary to edit the workflow thus: place the installer script in as a delayed script to run after 
first boot, then place a chmod script at the end of the sequence to run as the last step of the initial 
build process. Lo and behold, a working Sophos install.</p>

<p>Both of these scripts can be found in this <a href="https://git.sr.ht/~sporiff/sophos-mac" >Sourcehut repo</a>.</p>

<h2>Clearing False Positives</h2>

<p>This one may be seen by some as a bit of a nasty hack, but unfortunately Sophos - like any software - is 
imperfect. By default, the AV will quarantine or clean up PUAs and viruses from a host machine and 
report the status of this operation in the console, usually with a yellow exclamation triangle for medium 
status or a red exclamation circle for bad status. Usually, manually clearing out these problems is sufficient 
to repair the status, but sometimes the Sophos Health service gets, well, stuck.</p>

<p>Clearing this one is a little messy, as I say, but it's quite simple. First, the technician should verify 
that the threat has indeed been cleared. Then, tamper protection should be disabled on the affected machine. 
This is to allow the technician to stop the Sophos Health service, rename the stuck database, and re-enable 
the service. Tamper protection should then be enabled and the machine reset. Voilà! A nice green tick in Sophos Central.</p>

<h2>Going Forward</h2>

<p>Working with Sophos is something of an adventure. Due to the fact that it is cloud-based, it is always evolving. 
Sometimes, the changes are welcome - like a long-awaited fix for a problem - but other times they 
can present new challenges to which you will quickly need to adapt your environment. With a little scripting, 
Sophos management for endpoints becomes a lot easier.</p>
 </article>
<nav class="relative-nav">
<a href="https://sporiff.github.io/posts/date/Uncontrolled-Devices-Not-Even-Once.html">Previous</a><br>
<a href="https://sporiff.github.io/posts/date/Another-Day-Another-Intel-Fail.html">Next</a><br>
</nav>
 </main>  <footer class="fineprint"> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"> CC BY-SA 4.0 </a> by Ciarán Ainsworth <a href="https://my.fsf.org/join?referrer=2278905"><img src="https://sporiff.github.io/css/fsf.png" style="max-height: 1.5rem" /></a> </footer> </body> </html>