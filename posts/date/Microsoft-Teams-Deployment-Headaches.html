<!doctype html>
<html lang="en"> <head> <title>Life Inside a Computer</title> <meta http-equiv="content-type" content="text/html;" charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link href="https://sporiff.github.io/css/style.min.css" rel="stylesheet" type="text/css" /> <link rel="alternate" href="https://sporiff.github.io/rss.xml" type="application/rss+xml" /> <link rel="icon" type="image/png" href="https://sporiff.github.io/css/favicon.png" /> <meta name="flattr:id" content="d7zprl"> <meta property="twitter:card" content="summary" />
<meta property="twitter:author" content="@thatdapperbrit" />
<meta property="twitter:title" content="Microsoft Teams Deployment Headaches" />
<meta property="twitter:description" content="<p>So you want to use Microsoft Teams in your organisation, huh? Are you prepared for the pain? The lack of 
documentation? The feeling of utter exasperation at a company unable to properly consider " /> </head> <body> <nav class="navigation"> <a href="https://sporiff.github.io">Home</a> | <a href="mailto:ciaranainsworth@outlook.com">Email</a>  | <a href="https://github.com/Sporiff">Code</a>  | <a href="https://paypal.me/CiaranAinsworth">Support me</a>  | <a href="https://assets.rootkey.co.uk/static/resume.pdf">Resumé</a>  | <a href="https://sporiff.github.io/atom.xml">RSS</a>  </nav> <main id="content"> <section class="article-meta">
<h1 class="title">Microsoft Teams Deployment Headaches</h1>
<details open> <summary>Article Information</summary> <section class="tags">
Tagged as <a href="https://sporiff.github.io/tag/tech.html">tech</a>, <a href="https://sporiff.github.io/tag/windows.html">windows</a>, <a href="https://sporiff.github.io/tag/teams.html">teams</a>, <a href="https://sporiff.github.io/tag/microsoft.html">microsoft</a>, <a href="https://sporiff.github.io/tag/intune.html">intune</a>, <a href="https://sporiff.github.io/tag/azure.html">azure</a>, <a href="https://sporiff.github.io/tag/sccm.html">sccm</a> </section>
<section class="date">
Written on <time datetime="2018-07-14">2018-07-14</time> </section>
</section>
<article class="article-content">
<p>So you want to use Microsoft Teams in your organisation, huh? Are you prepared for the pain? The lack of 
documentation? The feeling of utter exasperation at a company unable to properly consider the needs of 
enterprise customers in their new &quot;modern&quot; approach? Well, I'm here to share my experiences with 
you so that hopefully you can avoid some of the pain I had to go through in getting this all ready for our 
upcoming rollout.</p>

<h2>SCCM Deployments</h2>

<p>Like many of you, my organisation utilises Microsoft's powerhouse deployment tool: SCCM. Initially, when 
Teams was released it was only available as an executable, which is fine. A little jiggery-pokery with 
detection methods yielded a usable application which could easily be deployed and self-served by users. 
Unfortunately, deploying the .exe and then trying to switch to the .msi requires the use of a 
<a href="https://docs.microsoft.com/en-us/MicrosoftTeams/scripts/powershell-script-teams-deployment-clean-up" >cleanup script</a> 
so we were lucky that Microsoft - in their infinite wisdom - decided to release 
<a href="https://docs.microsoft.com/en-us/MicrosoftTeams/msi-deployment" >the .msi &quot;machine-wide installer&quot;</a> 
before we started deploying. Saves us a bit of work.</p>

<p>The <code>.msi</code> installer, as you might imagine, works perfectly as an application. The only caveate is that 
the installer is per-user no matter what you specify in your application settings. The program installs 
to the users' AppData folder, so it can cause headaches in environments which make use of redirected AppData.</p>

<h2>Intune Deployments</h2>

<p>This is where things got a lot more complicated. Intune is at once a product with a great deal of documentation 
and one with absolutely no useful information. So when my co-worker and I initially uploaded the <code>.msi</code> to Intune 
we expected it to work. Nobody else had complained of any issues with the deployment via Intune, so we were surprised 
when every attempt at installation came back as having failed.</p>

<p>So here's the thing: Intune HATES deployments based on devices. Nearly every device configuration profile, compliance 
profile, and application deployment is expected to be done per-user. This does not fit our use-case, as users need to 
interact with many different devices in different contexts (e.g. shared user devices and personal devices). For that 
reason, we've had a lot of problems getting policies to work and are currently trying to get M$ to fix the issue.</p>

<p>But what about Teams? After all, the Chrome Enterprise installer worked fine targeting devices. The error message from 
Intune was that devices could not be targeted with user-based installers. But Teams is a &quot;machine-wide installer&quot;, right? 
Well, no. Not exactly. The installer basically just sets up a base downloader that is initiated by a user logging in. 
So how do you get Intune to recognise it as a device installer? You edit the <code>.msi</code> of course.</p>

<p>I personally use <a href="http://www.pantaray.com/msi_super_orca.html" >SuperOrca</a> to do this, but there are other 
tools available which can do the same job. Basically you just load up the <code>.msi</code> and add the following value 
to a new row. This will set the default installation target to &quot;machine&quot;, and will enable deployment of 
the <code>.msi</code> to device collections within Intune.</p>

<h2>Stopping AutoStart</h2>

<p>The single most annoying thing about Microsoft Teams is its inability to shut up. By default, the application is 
set to launch in the foreground at login. It's not a small app, either, so on older machines it increases load up 
time substantially. When you're trying to get non-techie users to use new tech (teachers, for example) the LAST 
thing you want to do is annoy them with clunky, slow applications.</p>

<p>So, I started poring over the documentation looking for an enterprise kill switch for this behaviour. An ADMX 
template, maybe? Doesn't look like it. A native GPO for Teams behaviour? Nope. Hmm. Okay then. Let's brush 
off <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" >Procmon</a> and look at what this is doing.</p>

<p>So it looks like when you enable/disable the autostart from within the Teams desktop application it writes and 
verifies a bunch of regkeys. The one we're interested in is this one:</p>

<pre><code>
HKCU\Software\Microsoft\Windows\CurrentVersion\Run
com.squirrel.Teams.Teams
C:\Users\%currentuser%\AppData\Local\Microsoft\Teams\Update.exe --processStart "Teams.exe" --process-start-args "--system-initiated"
  </code></pre>

<p>So, by creating a login script using group policy which searches for and removes this key, we effectively wipe 
out the autostart behaviour. Now, we have a working Teams deployment on SCCM. As for Intune, it remains to be seen 
whether or not creating a CSP and installing local GPOs will consistently suppress autostart. To be tested next week.</p>
 </article>
<nav class="relative-nav">
<a href="https://sporiff.github.io/posts/date/Back-to-the-Drawing-Board.html">Previous</a><br>
<a href="https://sporiff.github.io/posts/date/Deploying-and-Controlling-Google-Chrome-Settings-Using-Microsoft-Intune.html">Next</a><br>
</nav>
 </main>  <footer class="fineprint"> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"> CC BY-SA 4.0 </a> by Ciarán Ainsworth </footer> </body> </html>